#!/bin/bash
# author: ak1ra
# date: 2025-06-06

set -o errexit -o nounset -o pipefail

SCRIPT_NAME="$(basename "$(readlink -f "$0")")"

# Logging functions
log_color() {
    local color="$1"
    shift
    if [ -t 2 ]; then
        printf "\x1b[0;%sm%s\x1b[0m\n" "${color}" "$*" >&2
    else
        printf "%s\n" "$*" >&2
    fi
}

log_time() {
    local color="$1"
    shift
    log_color "$color" "[$(date -u +%Y-%m-%dT%H:%M:%S+0000)]$*"
}

log_error() {
    local RED=31
    log_color "$RED" "[ERROR] $*"
}

log_warning() {
    local YELLOW=33
    log_color "$YELLOW" "[WARNING] $*"
}

log_info() {
    local WHITE=37
    log_color "$WHITE" "[INFO] $*"
}

log_debug() {
    local BLUE=34
    if [ "${DEBUG:-false}" = "true" ]; then
        log_color "$BLUE" "[DEBUG] $*"
    fi
}

# Check if required commands are available
require_command() {
    for c in "$@"; do
        if ! command -v "$c" >/dev/null 2>&1; then
            log_error "Required command '$c' is not installed"
            exit 1
        fi
    done
}

usage() {
    cat <<EOF
Usage:
    $SCRIPT_NAME [-h|--help] | [-f|--fork] [-H|--hostname] [-t|--test] git_url

Options:
    -h, --help        Show this help message
    -f, --fork        Use 'upstream' as git remote name
    -H, --hostname    Use git_url hostname as git remote name
    -t, --test        Test pre-defined git_urls

EOF
    exit 0
}

strip_git_url() {
    local git_url="$1"
    if [[ -z "${git_url}" ]]; then
        log_error "Error: empty git URL provided"
        return 1
    fi

    echo "${git_url}" | sed -E \
        -e 's%^((https?|ssh|git):\/\/)?(git@)?([^\/:]+)[\/:]([-_.a-zA-Z0-9\/]+)$%\4/\5%' \
        -e 's%\.git$%%'
}

test_git_urls() {
    local -a git_urls=(
        git://github.com/user/repo.git
        http://github.com/user/repo.git
        https://github.com/user/repo.git
        git@github.com:user/repo.git
        ssh://git@github.com:user/repo.git

        git://gitlab.com/group/subgroup/project.git
        http://gitlab.com/group/subgroup/project.git
        https://gitlab.com/group/subgroup/project.git
        git@gitlab.com:group/subgroup/project.git
        ssh://git@gitlab.com:group/subgroup/project.git

        https://github.com/user/repo-with-dash.git
        https://github.com/user/repo_with_underscore.git
        https://github.com/user/repo.with.dot.git
    )

    local git_url
    for git_url in "${git_urls[@]}"; do
        printf "%-50s -> %s\n" "${git_url}" "$(strip_git_url "${git_url}")"
    done
}

git_clone() {
    local git_url="$1"
    if [[ -z "${git_url}" ]]; then
        log_error "Error: git URL is required"
        usage
    fi

    local relpath
    if ! relpath="$(strip_git_url "${git_url}")"; then
        log_error "Error: failed to parse git URL: ${git_url}"
        exit 1
    fi

    local repo_dir="${CODE_DIR}/${relpath}"
    if [[ -d "${repo_dir}/.git" ]]; then
        (
            set -x
            git --git-dir="${repo_dir}/.git" fetch --all
        )
        return
    fi

    local git_remote="${DEFAULT_REMOTE}"
    if [[ "${HOSTNAME_REMOTE}" == "true" ]]; then
        git_remote="${relpath%%/*}"
    fi

    (
        set -x
        git clone --origin="${git_remote}" "${git_url}" "${repo_dir}"
    )
}

main() {
    require_command git getopt sed

    declare -g DEFAULT_REMOTE="origin"
    declare -g HOSTNAME_REMOTE="false"

    # New-Item -ItemType Junction -Path $env:USERPROFILE\code -Value D:\code
    declare -g CODE_DIR="${HOME}/code"
    test -d "${CODE_DIR}" || mkdir -p "${CODE_DIR}"

    local args
    local options="hHft"
    local longoptions="help,hostname,fork,test"
    if ! args=$(getopt --options="${options}" --longoptions="${longoptions}" --name="${SCRIPT_NAME}" -- "$@"); then
        usage
    fi

    eval set -- "${args}"

    while true; do
        case "$1" in
            -h | --help)
                usage
                ;;
            -H | --hostname)
                HOSTNAME_REMOTE="true"
                shift
                ;;
            -f | --fork)
                DEFAULT_REMOTE="upstream"
                shift
                ;;
            -t | --test)
                test_git_urls
                exit 0
                ;;
            --)
                shift
                break
                ;;
            *)
                log_error "Unexpected option: $1"
                usage
                ;;
        esac
    done

    if [[ $# -ge 1 ]]; then
        git_clone "$@"
    else
        usage
    fi
}

main "$@"
