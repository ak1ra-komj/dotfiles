#!/bin/bash
# author: ak1ra
# date: 2025-06-06

set -o errexit

script_name="$(basename "$(readlink -f "$0")")"

# New-Item -ItemType Junction -Path $env:USERPROFILE\code -Value D:\code
base_dir="${HOME}/code"
test -d "${base_dir}" || mkdir -p "${base_dir}"

require_command() {
    for c in "$@"; do
        command -v "$c" >/dev/null || {
            echo >&2 "required command '$c' is not installed, aborting..."
            exit 1
        }
    done
}

usage() {
    cat <<EOF
Usage:
    $script_name [-h|--help] | [-f|--fork] [-H|--hostname] git_url

Options:
    -h, --help        print this help message
    -f, --fork        use 'upstream' as origin name
    -H, --hostname    use git_url hostname as origin name

EOF
    exit 0
}

strip_git_url() {
    sed -E \
        -e 's%^((https?|ssh|git):\/\/)?(git@)?([^\/:]+)[\/:]([-_.a-zA-Z0-9\/]+)$%\4/\5%' \
        -e 's%\.git$%%' -
}

test_git_urls() {
    git_urls=(
        git://github.com/user/repo.git
        http://github.com/user/repo.git
        https://github.com/user/repo.git
        git@github.com:user/repo.git
        ssh://git@github.com:user/repo.git

        git://gitlab.com/group/subgroup/project.git
        http://gitlab.com/group/subgroup/project.git
        https://gitlab.com/group/subgroup/project.git
        git@gitlab.com:group/subgroup/project.git
        ssh://git@gitlab.com:group/subgroup/project.git

        https://github.com/user/repo-with-dash.git
        https://github.com/user/repo_with_underscore.git
        https://github.com/user/repo.with.dot.git
    )

    for git_url in "${git_urls[@]}"; do
        printf "%-50s -> %s\n" "${git_url}" "$(strip_git_url <<<"${git_url}")"
    done
}

git_clone() {
    git_url="$1"
    test -n "${git_url}" || usage
    relpath="$(strip_git_url <<<"${git_url}")"

    repo_dir="${base_dir}/${relpath}"
    if [[ -d "${repo_dir}/.git" ]]; then
        (
            set -x
            git --git-dir="${repo_dir}/.git" fetch --all
        )
        return
    fi

    if [[ "${hostname_flag}" == "true" ]]; then
        origin="${relpath%%/*}"
    fi

    (
        set -x
        git clone --origin="${origin}" "${git_url}" "${repo_dir}"
    )
}

main() {
    ARGS="$(getopt --options 'hHft' --longoptions 'help,hostname,fork,test' -- "$@")"
    if ! eval set -- "${ARGS}"; then
        usage
    fi

    origin="origin"
    hostname_flag="false"
    while true; do
        case "$1" in
            -h | --help)
                usage
                ;;
            -H | --hostname)
                hostname_flag=true
                shift
                ;;
            -f | --fork)
                origin="upstream"
                shift
                ;;
            -t | --test)
                test_git_urls
                return
                ;;
            --)
                shift
                break
                ;;
            *)
                echo "unexpected option: $1"
                usage
                ;;
        esac
    done

    git_clone "$@"
}

main "$@"
