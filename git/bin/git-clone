#!/bin/bash
# author: ak1ra
# date: 2025-06-04

set -o errexit

require_command() {
    for c in "$@"; do
        command -v "$c" >/dev/null || {
            echo >&2 "required command '$c' is not installed, aborting..."
            exit 1
        }
    done
}

usage() {
    this="$(basename "$(readlink -f "$0")")"

    cat <<EOF
Usage:
    $this [-h|--help] | [-f|--fork] [-H|--hostname] git_url

Options:
    -h, --help        print this help message
    -f, --fork        use 'upstream' as origin name
    -H, --hostname    use git_url hostname as origin name

EOF
    exit 0
}

git_clone() {
    git_url="$1"
    test -n "${git_url}" || usage

    # convert git_url to POSIX path
    # git://example.com/user/repo.git
    # http://example.com/user/repo.git
    # https://example.com/user/repo.git
    # git@example.com:user/repo.git
    # git@example.com:group/subgroup/project.git
    # ssh://git@example.com:user/repo.git
    # ssh://git@example.com:group/subgroup/project.git
    relpath="$(sed -E 's%^(https?://|git://|ssh://)?([^/]+@)?([^/:]+)[/:](.+?)(\.git)?$%\3/\4%' <<<"${git_url}")"

    repo_dir="${base_dir}/${relpath}"
    if [[ -d "${repo_dir}/.git" ]]; then
        (
            set -x
            git --git-dir="${repo_dir}/.git" fetch --all
        )
        return
    fi

    if [[ "${hostname_flag}" == "true" ]]; then
        origin="${relpath%%/*}"
    fi

    (
        set -x
        git clone --origin="${origin}" "${git_url}" "${repo_dir}"
    )
}

main() {
    getopt_args="$(getopt --options 'hHf' --longoptions 'help,hostname,fork' -- "$@")"
    if ! eval set -- "${getopt_args}"; then
        usage
    fi

    origin="origin"
    hostname_flag="false"
    while true; do
        case "$1" in
        -h | --help)
            usage
            ;;
        -H | --hostname)
            hostname_flag=true
            shift
            ;;
        -f | --fork)
            origin="upstream"
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            echo "unexpected option: $1"
            usage
            ;;
        esac
    done

    git_clone "$@"
}

base_dir="${HOME}/code"
test -d "${base_dir}" || mkdir -p "${base_dir}"

main "$@"
