#!/usr/bin/env bash
#
# Recursively fetch all git repositories in parallel
#
# Usage: git-fetch [DIRECTORY [JOBS]]
#   DIRECTORY  Directory to search for git repositories (default: .)
#   JOBS       Number of parallel jobs (default: nproc)

set -o errexit -o nounset

search_dir="${1:-.}"
jobs="${2:-$(nproc)}"

if [[ ! -d "${search_dir}" ]]; then
    echo "Directory does not exist: ${search_dir}" >&2
    exit 1
fi

# shellcheck disable=SC2016
find "${search_dir}" -type d -name '.git' -print0 |
    xargs -0 -P "${jobs}" -I{} \
        sh -c 'GIT_TERMINAL_PROMPT=0 git -c credential.helper= --git-dir="$1" fetch --all </dev/null 2>&1 || true' -- {}
